/*!
  Clouds Animation jQuery Plugin
  @name jquery.clouds.js
  @author Max Lawrence 
  @version 2.2.0
  @category jQuery plugin
  @copyright (c) 2015 Max Lawrence (http://www.avirtum.com)
*/
!function(a){"use strict";function b(a,b){this.config=null,this.container=null,this.renderer=null,this.scene=null,this.camera=null,this.aspect=0,this.cameraX={value:0,min:-50,max:50},this.cameraY={value:0,min:-100,max:50},this.cameraRotation={value:0},this.init(a,b)}var c=function(){function a(){}return a.prototype.webgl=function(){try{var a=document.createElement("canvas");return!(!window.WebGLRenderingContext||!a.getContext("webgl")&&!a.getContext("experimental-webgl"))}catch(b){return!1}},a}(),d="clouds";b.prototype={VERSION:"2.2.0",defaults:{imageCloud:"",cloudSpeed:1,skyColor:"#ffffff",skyColorPower:50,cameraControl:!1,cameraXSpeed:.01,cameraYSpeed:.02,cloudData:[]},cameraNearClipPlane:1,cameraFarClipPlane:1e3,vFOV:60,init:function(a,b){this.container=a,this.config=b,this.create()},create:function(){if(!this.util().webgl())throw Error("Your browser does not support WebGL.");this.resetListeners(),this.resetScene(),this.load()},load:function(){var b={};b.cloud=this.config.imageCloud;var c=0,d=0;for(var e in b)b.hasOwnProperty(e)&&c++;for(var e in b)if(b.hasOwnProperty(e)){var f=new XMLHttpRequest;f.open("GET",b[e],!0),f.crossOrigin="Anonymous",f.responseType="arraybuffer",f.customKey=e,f.onload=a.proxy(function(e){var f=e.currentTarget;if(f.status>=400)return f.onerror(e);var g=new Blob([f.response]),h=new Image;h.src=window.URL.createObjectURL(g),h.onload=a.proxy(function(a){b[a.customKey]=h,++d==c&&(this.applyListeners(),this.buildScene(b),this.renderScene())},this,f)},this),f.onerror=a.proxy(function(a){var b=a.currentTarget;throw Error("Cannot load resource "+b.responseURL+". Status code ["+b.status+"]")},this),f.send()}},buildScene:function(a){var b=this.container.width(),c=this.container.height();this.aspect=b/c,this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(this.vFOV,this.aspect,this.cameraNearClipPlane,this.cameraFarClipPlane),this.camera.position.z=this.cameraFarClipPlane,this.scene.add(this.camera);var d=this.createTexture(a,"cloud");this.buildClouds(d),this.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(b,c),this.container.append(this.renderer.domElement)},buildClouds:function(a){var b={uniforms:{texCloud:{type:"t",value:null},skyColor:{type:"c",value:null},fogFar:{type:"f",value:null},fogNear:{type:"f",value:null},horizonLength:{type:"f",value:null}},vs:["varying vec2 vUv;","void main()","{","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fs:["uniform sampler2D texCloud;","uniform vec3 skyColor;","uniform float fogFar;","uniform float fogNear;","uniform float horizonLength;","varying vec2 vUv;","void main()","{","float distance = gl_FragCoord.z / gl_FragCoord.w;","float fogFactor = smoothstep( fogNear, fogFar, distance );","gl_FragColor = texture2D( texCloud, vUv );","if(distance >= (horizonLength - 200.0)) {","gl_FragColor.a *= 1.0 - ((distance - (horizonLength - 200.0)) / 200.0);","} else if(distance <= 200.0) {","gl_FragColor.a *= (distance / 200.0);","}","gl_FragColor = mix( gl_FragColor, vec4( skyColor, gl_FragColor.w ), fogFactor );","}"].join("\n")};b.uniforms.texCloud.value=a;var c=1-.01*Math.min(Math.max(parseInt(this.config.skyColorPower,10),0),100),d=new THREE.Fog(this.config.skyColor,this.cameraFarClipPlane*c,this.cameraFarClipPlane);b.uniforms.skyColor.value=d.color,b.uniforms.fogFar.value=d.far,b.uniforms.fogNear.value=d.near,b.uniforms.horizonLength.value=this.cameraFarClipPlane;for(var e=new THREE.ShaderMaterial({uniforms:b.uniforms,vertexShader:b.vs,fragmentShader:b.fs,depthWrite:!1,depthTest:!1,transparent:!0}),f=Math.tan(this.vFOV/2*Math.PI/180)*this.cameraFarClipPlane*2*2,g=f*this.aspect,h=new THREE.Geometry,i=0;i<this.cameraFarClipPlane;i++){for(var j=new THREE.PlaneGeometry(128,128),k=Math.random()*g-g/2,l=-Math.random()*Math.random()*f/40-f/20,m=i,n=Math.random()*Math.PI,o=2*Math.random()+.5,p=0;p<this.config.cloudData.length;p++)if(this.config.cloudData[p].i==i){var q=this.config.cloudData[p];q.hasOwnProperty("x")&&(k=q.x*g-g/2),q.hasOwnProperty("y")&&(l=q.y*f-f/2),q.hasOwnProperty("rotate")&&(n=q.rotate*Math.PI),q.hasOwnProperty("scale")&&(o=q.scale);break}j.center(),j.rotateZ(n),j.scale(o,o,1),j.translate(k,l,m),h.merge(j)}var r=new THREE.Mesh(h,e);this.scene.add(r),r=new THREE.Mesh(h,e),r.position.z=-this.cameraFarClipPlane,this.scene.add(r)},resetScene:function(){this.animationId&&cancelAnimationFrame(this.animationId),this.renderer=null,this.scene=null,this.camera=null,this.container.empty()},renderScene:function(){this.animationId=requestAnimationFrame(a.proxy(this.renderScene,this)),this.camera.position.z-=this.config.cloudSpeed,this.camera.position.z<0&&(this.camera.position.z=this.cameraFarClipPlane),this.camera.position.x+=(this.cameraX.value-this.camera.position.x)*this.config.cameraXSpeed,this.camera.position.y+=(this.cameraY.value-this.camera.position.y)*this.config.cameraYSpeed,this.camera.rotation.z+=.05*(this.cameraRotation.value-this.camera.rotation.z),this.renderer.render(this.scene,this.camera)},pause:function(){this.animationId&&cancelAnimationFrame(this.animationId)},play:function(){this.renderScene()},applyListeners:function(){this.config.cameraControl&&(this.container.on("mousemove.clouds",a.proxy(this.onMouseMove,this)),this.container.on("touchmove.clouds",a.proxy(this.onMouseMove,this))),a(window).on("resize.clouds",a.proxy(this.onWindowResize,this))},resetListeners:function(){this.container.off("mousemove.clouds"),this.container.off("touchmove.clouds"),a(window).off("resize.clouds")},onMouseMove:function(a){var b=this.getMousePositionPower("touchmove"==a.type?a.originalEvent.targetTouches[0]:a);this.cameraX.value=b.x<0?b.x*Math.abs(this.cameraX.min):b.x*Math.abs(this.cameraX.max),this.cameraY.value=b.y<0?b.y*Math.abs(this.cameraY.min):b.y*Math.abs(this.cameraY.max),this.cameraRotation.value=.03*b.x},onWindowResize:function(a){this.aspect=this.container.width()/this.container.height(),this.camera.aspect=this.aspect,this.camera.updateProjectionMatrix(),this.renderer.setSize(this.container.width(),this.container.height())},destroy:function(){this.resetListeners(),this.resetScene()},getMousePositionPower:function(a){var b=this.container.get(0).getBoundingClientRect(),c={},d=(b.right-b.left)/2,e=(b.bottom-b.top)/2,f=this.container.offset();return c.x=(a.pageX-f.left-d)/d,c.y=(e-(a.pageY-f.top))/e,c},createTexture:function(a,b){var c=new THREE.Texture;return c.image=a[b],c.needsUpdate=!0,c},util:function(){return null!=this._util?this._util:this._util=new c}},a.clouds=function(a,b){if("support"==a){new c;return this.util().webgl()?!0:!1}},a.fn.clouds=function(c,e){return this.each(function(){var e=a(this),f=e.data(d),g=a.isPlainObject(c)?c:{};if("destroy"==c){if(!f)throw Error("Calling 'destroy' method on not initialized instance is forbidden");return void f.destroy()}if("pause"==c){if(!f)throw Error("Calling 'pause' method on not initialized instance is forbidden");return void f.pause()}if("play"==c){if(!f)throw Error("Calling 'play' method on not initialized instance is forbidden");return void f.play()}if(f){var h=a.extend({},f.config,g);f.init(e,h)}else{var h=a.extend({},b.prototype.defaults,g);f=new b(e,h),e.data(d,f)}})}}(window.jQuery);